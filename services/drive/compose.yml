# Drive - File storage & editing

services:

  drive-backend:
    image: lasuite/drive-backend:${DRIVE_VERSION:-v0.13.0}
    profiles: [drive]
    restart: unless-stopped
    volumes:
      - ./config/settings/drive_local.py:/app/drive_local.py:ro
    environment:
      DJANGO_SETTINGS_MODULE: drive_local
      DJANGO_CONFIGURATION: Local
      DJANGO_SECRET_KEY: ${DRIVE_SECRET_KEY}
      DJANGO_ALLOWED_HOSTS: "*"
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: ${DRIVE_DB_NAME}
      DB_USER: ${SHARED_DB_USER}
      DB_PASSWORD: ${SHARED_DB_PASSWORD}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/2
      S3_ENDPOINT_URL: ${S3_URL:-http://rustfs:9000}
      AWS_S3_ENDPOINT_URL: ${S3_URL:-http://rustfs:9000}
      AWS_S3_ACCESS_KEY_ID: ${RUSTFS_ACCESS_KEY}
      AWS_S3_SECRET_ACCESS_KEY: ${RUSTFS_SECRET_KEY}
      AWS_STORAGE_BUCKET_NAME: drive-storage
      OIDC_RP_CLIENT_ID: masuite
      OIDC_RP_CLIENT_SECRET: ${SHARED_OIDC_CLIENT_SECRET}
      OIDC_OP_AUTHORIZATION_ENDPOINT: ${KEYCLOAK_URL}/realms/masuite/protocol/openid-connect/auth
      OIDC_OP_TOKEN_ENDPOINT: http://keycloak:8080/realms/masuite/protocol/openid-connect/token
      OIDC_OP_JWKS_ENDPOINT: http://keycloak:8080/realms/masuite/protocol/openid-connect/certs
      OIDC_OP_USER_ENDPOINT: http://keycloak:8080/realms/masuite/protocol/openid-connect/userinfo
      OIDC_RP_SIGN_ALGO: RS256
      OIDC_RP_SCOPES: "openid email"
      # WOPI (document editing)
      WOPI_CLIENTS: collabora
      WOPI_COLLABORA_DISCOVERY_URL: http://collabora:9980/hosting/discovery
      WOPI_SRC_BASE_URL: http://drive-backend:8000
      COLLABORA_URL: http://collabora:9980
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  drive-celery:
    image: lasuite/drive-backend:${DRIVE_VERSION:-v0.13.0}
    profiles: [drive]
    restart: unless-stopped
    command: celery -A drive.celery_app worker --beat -l INFO
    environment:
      DJANGO_SETTINGS_MODULE: drive.settings
      DJANGO_CONFIGURATION: Production
      DJANGO_SECRET_KEY: ${DRIVE_SECRET_KEY}
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: ${DRIVE_DB_NAME}
      DB_USER: ${SHARED_DB_USER}
      DB_PASSWORD: ${SHARED_DB_PASSWORD}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/2
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  drive-frontend:
    image: lasuite/drive-frontend:${DRIVE_VERSION:-main}
    profiles: [drive]
    restart: unless-stopped

  collabora:
    image: collabora/code:${COLLABORA_VERSION:-24.04.12.1.1}
    platform: linux/amd64
    profiles: [drive]
    restart: unless-stopped
    environment:
      aliasgroup1: http://drive-backend:8000
      extra_params: --o:ssl.enable=false --o:ssl.termination=true
      username: admin
      password: ${DRIVE_SECRET_KEY}
    cap_add:
      - MKNOD
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9980/hosting/discovery"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
