# Shared infrastructure (always running)

services:

  # --- Caddy (reverse proxy for all apps) ---
  caddy:
    image: caddy:${CADDY_VERSION:-2-alpine}
    restart: unless-stopped
    ports:
      - "127.0.0.1:9120-9129:9120-9129"
      - "127.0.0.1:9200-9209:9200-9209"
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./services:/etc/caddy/services:ro
      - ./config/homepage:/srv/homepage:ro
      - caddy-data:/data
      - caddy-config:/config

  # --- PostgreSQL ---
  postgres:
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    restart: unless-stopped
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./config/postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro
    environment:
      POSTGRES_USER: masuite
      POSTGRES_PASSWORD: ${POSTGRES_ADMIN_PASSWORD}
      POSTGRES_DB: masuite
      # Shared app database user
      APP_DB_USER: ${SHARED_DB_USER}
      APP_DB_PASSWORD: ${SHARED_DB_PASSWORD}
      # Space-separated list of app database names (generated by setup wizard)
      APP_DB_NAMES: ${APP_DB_NAMES:-}
      # Keycloak (separate user)
      KEYCLOAK_DB_NAME: keycloak_db
      KEYCLOAK_DB_USER: keycloak_user
      KEYCLOAK_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-${POSTGRES_ADMIN_PASSWORD}}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U masuite"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- Redis ---
  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- S3-compatible storage (RustFS) ---
  rustfs:
    # Pinned to alpha.82: alpha.83+ crashes on CPUs without AVX (rustfs/rustfs#1838)
    image: rustfs/rustfs:1.0.0-alpha.82
    restart: unless-stopped
    user: "0:0"
    volumes:
      - ./data/objectstorage:/data
    environment:
      RUSTFS_ACCESS_KEY: ${RUSTFS_ACCESS_KEY}
      RUSTFS_SECRET_KEY: ${RUSTFS_SECRET_KEY}
      RUSTFS_ADDRESS: ":9000"
      RUSTFS_CONSOLE_ADDRESS: ":9001"
      RUSTFS_CONSOLE_ENABLE: "true"
    healthcheck:
      test: ["CMD-SHELL", "curl -so /dev/null http://localhost:9000/ || exit 1"]
      interval: 10s
      timeout: 5s
      start_period: 10s
      retries: 5

  rustfs-init:
    image: minio/mc:latest
    depends_on:
      rustfs:
        condition: service_healthy
    restart: "no"
    entrypoint: /bin/sh
    command:
      - -c
      - |
        mc alias set masuite http://rustfs:9000 ${RUSTFS_ACCESS_KEY} ${RUSTFS_SECRET_KEY}
        for bucket in ${S3_BUCKETS}; do mc mb --ignore-existing masuite/$$bucket; done
        echo 'RustFS buckets initialized.'

  # --- Keycloak ---
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    restart: unless-stopped
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak_db
      KC_DB_USERNAME: keycloak_user
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-${POSTGRES_ADMIN_PASSWORD}}
      KC_HOSTNAME: ${KEYCLOAK_URL:-http://localhost:9200}
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY_HEADERS: xforwarded
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      # Note: OIDC client secret is set via Admin API after startup (keycloak_setup.py)
    command: start --import-realm
    volumes:
      - ./config/keycloak:/opt/keycloak/data/import:ro
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  caddy-data:
  caddy-config:
